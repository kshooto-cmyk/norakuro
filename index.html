<!-- 以下はindex.htmlファイルの修正部分です -->

<script>
// 商品データと注文リストの管理
let products = [];
let orderList = JSON.parse(localStorage.getItem('orderList')) || [];

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // ローカルストレージから注文リストを読み込み
    try {
        const storedOrderList = localStorage.getItem('orderList');
        if (storedOrderList) {
            orderList = JSON.parse(storedOrderList);
        }
    } catch (e) {
        console.error('ローカルストレージの読み込みに失敗しました:', e);
        orderList = [];
    }
    
    updateOrderListButton();
    
    // 商品データの取得を試みる - パスを明示的に指定
    fetch('./products.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('loading-message').style.display = 'none';
            
            // データの型を変換（discountRateを数値に）
            products = data.map(item => ({
                id: item.id.toString(), // IDを文字列に統一
                name: item.name,
                price: Number(item.price),
                discountRate: Number(item.discountRate || 0),
                description: item.description || '',
                imageURL: item.imageURL || '',
                category: item.category || ''
            }));
            
            displayProducts(products);
        })
        .catch(error => {
            console.error('商品データの取得中にエラーが発生しました:', error);
            // エラー時は空の商品リストを表示
            document.getElementById('loading-message').style.display = 'none';
            products = [];
            document.getElementById('products-container').innerHTML = 
                '<p class="error-message">商品データの読み込みに失敗しました。ページを再読み込みしてください。</p>';
        });
    
    // 郵便番号検索ボタンのイベントリスナーを追加
    document.getElementById('postal-search-btn').addEventListener('click', searchPostalCode);
    
    // 郵便番号入力欄でEnterキーが押されたときも検索を実行
    document.getElementById('postal-code').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchPostalCode();
        }
    });
});

// 商品カードの作成関数を修正
function createProductElement(product) {
    const div = document.createElement('div');
    div.className = 'product-card';
    
    // 割引価格の計算
    const discountedPrice = product.discountRate > 0 
        ? Math.floor(product.price * (1 - product.discountRate / 100))
        : product.price;
    
    const priceHTML = product.discountRate > 0 
        ? `<p class="product-price"><span class="discount">¥${product.price.toLocaleString()}</span> ¥${discountedPrice.toLocaleString()}</p>`
        : `<p class="product-price">¥${product.price.toLocaleString()}</p>`;
    
    // 画像がない場合のプレースホルダー
    const imageHTML = product.imageURL 
        ? `<img src="${product.imageURL}" alt="${product.name}" class="product-image">`
        : `<div class="product-image">画像なし</div>`;
    
    div.innerHTML = `
        ${imageHTML}
        <h3 class="product-title">${product.name}</h3>
        <p class="product-description">${product.description}</p>
        ${priceHTML}
        <div class="quantity-controls">
            <button class="quantity-btn" onclick="decreaseQuantity('${product.id}')">-</button>
            <span class="quantity-display" id="quantity-${product.id}">1</span>
            <button class="quantity-btn" onclick="increaseQuantity('${product.id}')">+</button>
        </div>
        <button class="add-to-list-btn" onclick="addToOrderList('${product.id}')">リストに加える</button>
    `;
    
    return div;
}

// 注文リストへの追加関数を修正
function addToOrderList(productId) {
    const quantityElement = document.getElementById(`quantity-${productId}`);
    if (!quantityElement) {
        console.error('数量要素が見つかりません:', `quantity-${productId}`);
        alert('商品情報の読み込みに問題があります。ページを再読み込みしてください。');
        return;
    }
    
    const quantity = parseInt(quantityElement.textContent);
    const product = products.find(p => p.id === productId);
    
    if (!product) {
        console.error('商品が見つかりません:', productId);
        alert('商品情報の読み込みに問題があります。ページを再読み込みしてください。');
        return;
    }
    
    // 割引価格の計算
    const itemPrice = product.discountRate > 0 
        ? Math.floor(product.price * (1 - product.discountRate / 100))
        : product.price;
    
    const existingItem = orderList.find(item => item.id === productId);
    
    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        orderList.push({
            id: product.id,
            name: product.name,
            price: itemPrice,
            quantity: quantity,
            image: product.imageURL
        });
    }
    
    // ローカルストレージに保存
    try {
        localStorage.setItem('orderList', JSON.stringify(orderList));
        updateOrderListButton();
        alert('注文リストに追加しました');
        
        // 数量をリセット
        quantityElement.textContent = '1';
    } catch (e) {
        console.error('ローカルストレージの保存に失敗しました:', e);
        alert('注文リストへの追加に失敗しました。');
    }
}

// 残りの関数は変更なし
</script>