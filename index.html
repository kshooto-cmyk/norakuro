<script>
    // 商品データと注文リストの管理
    let products = [];
    let orderList = JSON.parse(localStorage.getItem('orderList')) || [];

    document.addEventListener('DOMContentLoaded', function() {
        // products.jsonから商品データを取得
        fetch('products.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 取得したデータを `products` 配列に代入
                products = data.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    discountRate: item.discountRate,
                    description: item.description || '',
                    imageURL: item.imageURL,
                    category: item.category
                }));
                // 商品をカテゴリ別に表示
                displayProductsByCategory(products);
            })
            .catch(error => {
                console.error('商品データの取得中にエラーが発生しました:', error);
                const container = document.getElementById('products-by-category');
                container.innerHTML = '<p class="error-message">商品データの読み込みに失敗しました。</p>';
            });

        updateOrderListButton();
    });

    // ページ表示制御
    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.add('hidden');
            page.classList.remove('active');
        });
        
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        document.getElementById(`${pageId}-page`).classList.add('active');
        
        if (pageId === 'order') {
            displayOrderList();
            calculateTotal();
        }
        
        window.scrollTo(0, 0);
    }

    // 商品をカテゴリ別に表示
    function displayProductsByCategory(products) {
        const container = document.getElementById('products-by-category');
        container.innerHTML = '';
        
        if (products.length === 0) {
            container.innerHTML = '<p class="error-message">商品データが見つかりませんでした。</p>';
            return;
        }
        
        const categories = {};
        products.forEach(product => {
            if (!categories[product.category]) {
                categories[product.category] = [];
            }
            categories[product.category].push(product);
        });
        
        for (const [category, categoryProducts] of Object.entries(categories)) {
            const section = document.createElement('div');
            section.className = 'category-section';
            
            const title = document.createElement('h3');
            title.className = 'category-title';
            title.textContent = category;
            
            const productsContainer = document.createElement('div');
            productsContainer.className = 'products-container';
            
            categoryProducts.forEach(product => {
                const productElement = createProductElement(product);
                productsContainer.appendChild(productElement);
            });
            
            section.appendChild(title);
            section.appendChild(productsContainer);
            container.appendChild(section);
        }
    }

    // 商品カードの作成
    function createProductElement(product) {
        const div = document.createElement('div');
        div.className = 'product-card';
        
        const priceHTML = product.discountRate > 0 
            ? `<p class="product-price"><span class="discount">¥${product.price.toLocaleString()}</span> ¥${calculateDiscountPrice(product).toLocaleString()}</p>`
            : `<p class="product-price">¥${product.price.toLocaleString()}</p>`;
        
        const imageHTML = product.imageURL 
            ? `<img src="${product.imageURL}" alt="${product.name}" class="product-image">`
            : `<div class="product-image">画像なし</div>`;
        
        const descriptionHTML = product.description 
            ? `<p class="product-description">${product.description}</p>`
            : '';
        
        div.innerHTML = `
            ${imageHTML}
            <h3 class="product-title">${product.name}</h3>
            ${descriptionHTML}
            ${priceHTML}
            <div class="quantity-controls">
                <button class="quantity-btn" onclick="decreaseQuantity(${product.id})">-</button>
                <span class="quantity-display" id="quantity-${product.id}">1</span>
                <button class="quantity-btn" onclick="increaseQuantity(${product.id})">+</button>
            </div>
            <button class="add-to-list-btn" onclick="addToOrderList(${product.id})">リストに加える</button>
        `;
        
        return div;
    }

    // 割引価格の計算
    function calculateDiscountPrice(product) {
        return Math.floor(product.price * (1 - product.discountRate / 100));
    }

    // 数量増減
    function increaseQuantity(productId) {
        const quantityElement = document.getElementById(`quantity-${productId}`);
        let quantity = parseInt(quantityElement.textContent);
        quantityElement.textContent = quantity + 1;
    }

    function decreaseQuantity(productId) {
        const quantityElement = document.getElementById(`quantity-${productId}`);
        let quantity = parseInt(quantityElement.textContent);
        if (quantity > 1) {
            quantityElement.textContent = quantity - 1;
        }
    }

    // 注文リストへの追加 - 修正箇所
    function addToOrderList(productId) {
        const quantity = parseInt(document.getElementById(`quantity-${productId}`).textContent);
        // 商品IDを数値に変換して比較
        const product = products.find(p => p.id === productId);
        
        if (!product) {
            console.error('商品が見つかりません:', productId);
            return;
        }
        
        // 既存アイテムを検索（数値比較）
        const existingItemIndex = orderList.findIndex(item => item.id === productId);
        
        if (existingItemIndex !== -1) {
            // 既に存在する場合は数量を追加
            orderList[existingItemIndex].quantity += quantity;
        } else {
            // 新規追加
            orderList.push({
                id: product.id,
                name: product.name,
                price: product.discountRate > 0 ? calculateDiscountPrice(product) : product.price,
                quantity: quantity,
                image: product.imageURL
            });
        }
        
        localStorage.setItem('orderList', JSON.stringify(orderList));
        updateOrderListButton();
        alert('注文リストに追加しました');
        
        document.getElementById(`quantity-${productId}`).textContent = '1';
    }

    // 注文リストボタンの更新
    function updateOrderListButton() {
        const button = document.getElementById('order-count');
        const totalItems = orderList.reduce((total, item) => total + item.quantity, 0);
        button.textContent = `(${totalItems})`;
    }

    // 注文リストの表示
    function displayOrderList() {
        const container = document.getElementById('order-items');
        container.innerHTML = '';
        
        if (orderList.length === 0) {
            container.innerHTML = '<p>注文リストに商品がありません</p>';
            return;
        }
        
        orderList.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'order-item';
            
            const imageHTML = item.image 
                ? `<img src="${item.image}" alt="${item.name}" width="60">`
                : `<div style="width:60px; height:60px; background:#f0f0f0; display:flex; align-items:center; justify-content:center;">画像なし</div>`;
            
            itemElement.innerHTML = `
                ${imageHTML}
                <div class="order-item-info">
                    <h3>${item.name}</h3>
                    <p>¥${item.price.toLocaleString()} × ${item.quantity}</p>
                </div>
                <p>¥${(item.price * item.quantity).toLocaleString()}</p>
                <button class="remove-item" onclick="removeFromOrderList(${item.id})">×</button>
            `;
            container.appendChild(itemElement);
        });
    }

    // 注文リストから商品を削除
    function removeFromOrderList(productId) {
        orderList = orderList.filter(item => item.id !== productId);
        localStorage.setItem('orderList', JSON.stringify(orderList));
        displayOrderList();
        calculateTotal();
        updateOrderListButton();
    }

    // 合計金額の計算
    function calculateTotal() {
        const subtotal = orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal < 2000 && subtotal > 0 ? 300 : 0;
        const total = subtotal + shipping;
        
        document.getElementById('subtotal').textContent = `¥${subtotal.toLocaleString()}`;
        document.getElementById('shipping').textContent = shipping > 0 ? `¥${shipping.toLocaleString()}` : '無料';
        document.getElementById('total').textContent = `¥${total.toLocaleString()}`;
    }

    // 注文送信
    async function submitOrder() {
        // ハニーポットチェック
        const honeyPot = document.getElementById('website').value;
        if (honeyPot) {
            alert('送信に失敗しました。もう一度お試しください。');
            return;
        }
        
        const email = document.getElementById('email').value;
        const emailConfirm = document.getElementById('email-confirm').value;
        
        if (email !== emailConfirm) {
            alert('メールアドレスが一致しません。');
            return;
        }
        
        const requiredFields = ['name', 'email', 'tel', 'postal-code', 'address', 'payment-method'];
        for (let field of requiredFields) {
            const element = document.getElementById(field);
            if (!element.value) {
                alert('すべての必須項目を入力してください。');
                element.focus();
                return;
            }
        }
        
        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            tel: document.getElementById('tel').value,
            postalCode: document.getElementById('postal-code').value,
            address: document.getElementById('address').value,
            paymentMethod: document.getElementById('payment-method').value
        };
        
        const orderData = {
            orderId: generateOrderId(),
            items: orderList,
            customer: formData,
            subtotal: orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            shipping: orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0) < 2000 ? 300 : 0,
            total: calculateTotalValue(),
            timestamp: new Date().toISOString()
        };
        
        await processOrder(orderData);
    }

    function calculateTotalValue() {
        const subtotal = orderList.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal < 2000 && subtotal > 0 ? 300 : 0;
        return subtotal + shipping;
    }

    function generateOrderId() {
        return 'NL' + Date.now() + Math.floor(Math.random() * 1000);
    }

    async function processOrder(orderData) {
        const submitBtn = document.getElementById('submit-order-btn');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '送信中... <span class="loading"></span>';
            
            const response = await fetch('https://script.google.com/macros/s/AKfycbwNqitBfTAdyao6uRbQ1i-nEdWQBFro1WQ_-TZKmbCc4V3OHKuPnDsIZ5cROgG_bMObRg/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            });
            
            orderList = [];
            localStorage.removeItem('orderList');
            updateOrderListButton();
            
            alert(`注文が完了しました。\n注文ID: ${orderData.orderId}\n合計金額: ¥${orderData.total.toLocaleString()}\n確認メールを送信しました。`);
            
            document.querySelectorAll('.order-form input, .order-form select, .order-form textarea').forEach(input => {
                input.value = '';
            });
            
            showPage('home');
            
        } catch (error) {
            console.error('注文処理中にエラーが発生しました:', error);
            alert('注文の送信中にエラーが発生しました。もう一度お試しください。');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }
</script>